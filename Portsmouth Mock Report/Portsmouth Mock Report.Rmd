---
title: "Untitled"
author: "Church Army's Research Unit"
date: "Some-date"
output:
  word_document:
    reference_docx: caRefDoc.docx
---

```{r behindTheScenes, include = FALSE, echo = FALSE}
#Five hashes is a fifth level heading, which is set to be a pagebreak in the reference document
#NB I think this template needs a little work
knitr::opts_chunk$set(echo = FALSE)

leaders <- readRDS("O:\\WCC\\Learning and Development\\Research\\PROJECT - Portsmouth 2019 onwards\\Data\\leaders & attenders\\leadersResponses2018and2019.rdat")

attenders <- readRDS("O:\\WCC\\Learning and Development\\Research\\PROJECT - Portsmouth 2019 onwards\\Data\\leaders & attenders\\attenders2018NoUnderFives.rdat")

# ^ Note that the above files are coming from 'static' locations - there are no markdown files that will automatically update any of that stuff. 
```

```{r libraries, include = FALSE}
library("mapsapi")
library("dplyr")
library("magrittr")
library("stringr")
library("purrr")
library("XML")
library("sf")
library("ggmap")
library("ggplot2")
library("ggmap")
```

```{r createArchitecture}
suppressWarnings(dir.create(here::here("data")))
```

```{r getGoogleCoords}
### Looking to get Google Coordinates
### 
### if(the coordinates exist){just use them}
### otherwise{try to make them by looking for a google maps api key}
### but if(you can't find an api key){throw a very informative error}
if(file.exists(here::here("data\\latLong.rdat")))
{
  latLongTib <- readRDS(here::here("data\\latLong.rdat"))
  leaders %<>% 
    left_join(latLongTib, by = "responseId")
  
  message("latLong.rdat found in \\data")
  
} else {
  
  lookForKeyHere <- "O:\\WCC\\Learning and Development\\Research\\Team member folders\\Dave Lovell\\keys\\googleMapsApi.csv"
  
  message("googleCoords.rdat not located in \\data.
Searching for Google Maps API key to generate coordinates")
  
  if(file.exists(here::here("data\\googleMapsApi.csv"))) {
    
    googleKey <- read.csv(here::here("data\\googleMapsApi.csv"))
    message("Maps API key found in \\data")
    
  } else if(file.exists(lookForKeyHere)) {
    
    googleKey <- read.csv(lookForKeyHere, row.names = FALSE)
    write.csv(googleKey, here::here("data\\googleMapsApi.csv"))
    message("Maps API key found on O drive. Saving to \\data")
      
  } else {
    stop("'latLongs.rdat' not found in \\data
and googleMapsApi.csv not found in \\data or on O Drive.
Either establish connection to 'O:\\\\', or talk to Dave Lovell
to get the csv, or get your own key and write a .csv with fields
`client` and `key`")
  } # Run the above if you can't find the google key
  
  googleKey <- googleKey$key
  
  # Cut websites from info_venueDetails to get addresses
  leaders %<>%
    mutate(address =
             info_venueDetails %>% 
             # This took a while - regex often counterintuitive
             # remove a string that has spaces (or eols) on either side
             # and otherwise consists of any number of anything but spaces
             # on either side of a '.co' or '.com' or '.org' or '.uk'
    str_remove_all("(?<=[:space:]|^)[^[:space:]]*(\\.co|\\.com|\\.org|\\.uk)[^[:space:]]*(?=[:space:]|$)"))
  
  ### coordGet Function: get Google data, then get lat/long numerics from XML data
  # xmlGet <- function(address, key) {
  #   mapsapi::mp_geocode(address = address, key) ->
  #     xml
  #   return(xml)
  # }
  
  # leaders %<>%
  #   mutate(xml = 
  #            map(list(address),
  #                ~ xmlGet(., key = googleKey)))
  # 
  coordGet <-
  function(address, key) {
    
    if(!is.character(address)|is.na(address)) {
      
      lat = NA
      lng = NA } else {
        
        mapsapi::mp_geocode(addresses = address, key = key)[[1]] %>% #shouldn't be longer than 1
      (XML::xmlParse) ->
      someXML
    
      XML::getNodeSet(someXML,"/GeocodeResponse/result/geometry/location/lat") ->
        latNode
      XML::getNodeSet(someXML, "/GeocodeResponse/result/geometry/location/lng") ->
        lngNode
  
      latNode %>% 
        (XML::toString.XMLNode) %>%
        str_extract("(?<=(<lat>)).+(?=(</lat>))") %>% 
        as.numeric ->
        lat
      
      lngNode  %>% 
        (XML::toString.XMLNode) %>%
        str_extract("(?<=(<lng>)).+(?=(</lng>))") %>% 
        as.numeric ->
        lng
      }
    
          coords <- list("lat" = lat,"lng" = lng)
      
      return(coords)
    }

  leaders %<>%
    mutate(latLong = map(as.list(address),
                         ~ coordGet(address = ., key = googleKey)))
  
  leaders %>% 
    select(responseId, address, latLong) ->
    latLongTib
  
  latLongTib%>% 
    saveRDS(here::here("data\\latLong.rdat"))
  
  leaders %<>%
    left_join(latLongTib %>% 
                select(-address),
              by = "responseId")
} # Run the above if the google data doesn't exist
```
##### 

# Portsmouth Pioneer Project Evaluation Quantitative Report - Mock-up

## Pioneer Posts

At the beginning of the Pioneer Project, the ambition was to see 12 new fxC begun each with 50-100 worshippers and for 15% of the diocesan church attendance to be in fxC (from 1200 to 2200).

```{r makingAMap}

  leaders %<>% 
  mutate(points = map(latLong,
                      ~ {
                        if(is.numeric(unlist(.["lat"])) &&
                           is.numeric(unlist(.["lng"]))) {
                          
                          st_point(c(unlist(.["lat"]),
                                 unlist(.["lng"])))
                        } else {
                            NA
                          }}) %T>%
           {map(., ~ print(class(.)))} %>% 
           map(~ {
             if(all(class(.) %in% c("XY", "POINT", "sfg"))) {
               
                 st_sfc(., crs = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs")
             } else
             {
               NA
             }
             
             }))

ggplot() +
  geom_sf(data = leaders, aes(geometry = points))

```

* fxC data from leaders and attenders surveys
* list of initiatives that didn't meet fxC criteria
* look at all fxC but focus in on any links with pioneer posts
* any fxC started by 'voluntary lay pioneers'

## Harbour Church
The original project plan aimed to “plant a large, city centre, resourcing church appealing to younger people. Within the 5 year timescales, we expect this to have grown to at least 200 worshippers and to be exploring a further plant”. 

This ambition was achieved within 18 months of Harbour Church’s planting  

## Pioneer Training & Vocations

* 'How to pioneer' course - numbers attending
* Recognised lay pioneers
* Pioneers accepted for reader and ordination training
* Who do the diocese consider to be pioneers (beyond the 'official' ones)?

## Culture Change
